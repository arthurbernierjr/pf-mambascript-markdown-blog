require('dotenv').config()
Mamba = require 'mambascript'
Mamba.register()
{ MambaView } = Mamba
express = require 'express'
app = express()
fs = require 'fs'
path = require 'path'
json = "#{__dirname}/json"
pillar = "#{__dirname}/json_pillar"
PORT = process.env.PORT || 8089
matter = require 'gray-matter'
showdown  = require 'showdown'
converter = new showdown.Converter()
mongoose = require 'mongoose'
leads = require './models/leadController.mamba'
updateLead = require './models/updateLead.mamba'
MONGODB_URI = process.env.MONGO_URI
db = mongoose.connection

mongoose.connect MONGODB_URI, {
    useNewUrlParser: true
    useUnifiedTopology: true
}

db.on 'open', -> present 'Connected to Mongo'


# Middleware
app.use express.json()
app.use express.urlencoded({ extended: true })
app.set 'views', './src'
app.set 'view engine', 'mamba'
app.engine 'mamba', require('./engine.js').createEngine()
app.use express.static('public')
app.use '/addLead', leads

app.get '/linkedin', (req, res) ->
  res.redirect('https://linkedin.com/in/bigpoppacode')

app.get '/twitter', (req, res) ->
  res.redirect('https://twitter.com/bigpoppacode')

app.get '/youtube', (req, res) ->
  res.redirect('https://youtube.com/@bigpoppacode')

app.get '/instagram', (req, res) ->
  res.redirect('https://instagram.com/bigpoppacode')

app.get '/portfolio', (req, res) ->
  res.redirect('https://github.com/arthurbernierjr')


getFirstPost = (req, res, next) ->
  fs.readFile "#{pillar}/start-here.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.locals = JSON.parse(file)
      next()

app.get '/', getFirstPost, (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile "/public/index.html"

app.get '/case-study', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','main.html')

# Blog landing page - hub for all content
app.get '/blog', (req, res) ->
  res.render 'pages/BlogLanding', {}

# Lessons page (redirect old /allposts to /lessons)
app.get '/allposts', (req, res) ->
  res.redirect(301, '/lessons')

app.get '/lessons', (req, res) ->
  fs.readFile "#{json}/all.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Blog', {
        posts: JSON.parse(file).sort((a,b) => a.data.order  - b.data.order)
      }
app.get '/about', (req, res) ->
  res.redirect(301, 'https://portfolio.bigpoppacode.io')

app.get '/contact', (req, res) ->
  res.redirect(301, 'https://portfolio.bigpoppacode.io')

app.get '/chatgpt', (req, res) ->
  fs.readFile "#{json}_static/chat-gpt-prompts-goldmine.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Show', {
        post: JSON.parse(file)
      }

app.get '/projects', (req, res) ->
  fs.readFile "#{json}_static/projects.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Projects', {
        post: JSON.parse(file)
      }

app.get '/programs', (req, res) ->
  res.sendFile path.resolve(__dirname, 'public','investfest.html')

app.get '/programs/:name', (req, res) ->
  fs.readFile "#{json}_static/#{req.params.name}.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Program', {
        post: JSON.parse(file)
      }
app.get '/a7575/ai-in-digital-marketing', (req, res) -> 
  fs.readFile "#{json}_static/ai-digital.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Program', {
        post: JSON.parse(file)
      }
app.get '/go/drumar', (req, res) ->
  res.redirect('https://youtu.be/kVV0g1FIBSg')

app.get '/go/roadtoqa', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://youtu.be/2wmzcWVPkhM')
  
app.get '/go/mattyj', (req, res) -> 
  res.redirect('https://youtu.be/kVV0g1FIBSg')#change to mattyj

app.get '/go/ai-in-digital-marketing-video', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','main.html')

app.get '/go/5million', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','5Million.html')

app.get '/go/mini-portfolio', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','mini-portfolio.html')

app.get '/go/code-different', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','code-different.html')

app.get '/go/code', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','code-different.html')

app.get '/go/code-class', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','code-1.html')

app.get '/go/5Million', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','5Million.html')

app.get '/go/digitalbossode', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://www.skool.com/digitalbosscode/about?ref=e3a89aaa604f4418b93b6e5d316026fe')

app.get '/go/digitalbosscode', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://www.skool.com/digitalbosscode/about?ref=e3a89aaa604f4418b93b6e5d316026fe')

app.get '/go/dbc', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://www.skool.com/digitalbosscode/about?ref=e3a89aaa604f4418b93b6e5d316026fe')

app.get '/go/dbav1', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://shop.beacons.ai/bigpoppacode/294f680a-f5b0-42bd-94e8-2f2ca348c08d')

app.get '/go/dbav2', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://shop.beacons.ai/bigpoppacode/28d2461b-4180-4087-bdc6-d3225ab06ed8')

app.get '/go/dbav3', (req, res) ->
  res.setHeader('Content-Type', 'text/html')
  res.redirect('https://shop.beacons.ai/bigpoppacode/34ac8abb-79f4-45cd-8d9d-4cf3bcae5d6f')

app.get '/go/2032', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','2032.html')

app.get '/go/2032/thankyou/4d3b987a3381f0b3b8f0cc44da78432deab50b88872f6faddf7e8b585e4e98dc', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','2032thankyou.html')

app.get '/go/27', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','27.html')

app.get '/go/ai-bonus', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','ai-bonus.html')

app.get '/go/build-your-own-empire', (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','27.html')

app.get '/go/27/thankyou/4d3b987a3381f0b3b8f0cc44da78432deab50b88872f6faddf7e8b585e4e98dc', updateLead, (req, res) -> 
  res.setHeader('Content-Type', 'text/html')
  res.sendFile path.resolve(__dirname, 'public','27thankyou.html')

app.get '/go/2032/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public', 'guides','2032-survival-guide.pdf')

app.get '/go/27/5million/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','5million.pdf')

app.get '/go/27/tewb/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','tewb.pdf')

app.get '/go/27/confessions/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','confessions.pdf')

app.get '/go/27/quickstart/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','quickstartguide.pdf')

app.get '/go/27/bonus1/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus1.pdf')

app.get '/go/27/bonus2/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus2.pdf')

app.get '/go/27/bonus3/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus3.pdf')

app.get '/go/27/bonus4/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus4.pdf')

app.get '/go/27/bonus5/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus5.pdf')

app.get '/go/27/bonus6/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus6.pdf') 

app.get '/go/27/bonus7/qwertyuiopxz', (req, res) -> 
  res.sendFile path.resolve(__dirname, 'public','guides','bonus7.pdf') 

app.get '/start-here', (req, res) ->
  fs.readFile "#{pillar}/start-here.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Show', {
        post: JSON.parse(file)
      }

app.get '/perscholas-cheatsheet', (req, res) ->
  fs.readFile "#{pillar}/git.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Show', {
        post: JSON.parse(file)
      }

# Guides routes - Developer documentation
guidesPath = "#{__dirname}/api/guides"

# Helper to parse markdown and render guide
renderGuide = (filePath, category, subcategory, res) ->
  fs.readFile filePath, 'utf8', (err, file) ->
    if err
      console.error(err)
      res.status(404).send('Guide not found')
    else
      parsed = matter(file)
      guide = {
        data: parsed.data
        content: converter.makeHtml(parsed.content)
      }
      res.render 'pages/Guides', {
        guide: guide
        category: category
        subcategory: subcategory
      }

# Main guides index
app.get '/guides', (req, res) ->
  renderGuide "#{guidesPath}/index.md", null, null, res

# Category index (e.g., /guides/javascript)
app.get '/guides/:category', (req, res) ->
  { category } = req.params
  indexPath = "#{guidesPath}/#{category}/index.md"
  fs.access indexPath, fs.constants.F_OK, (err) ->
    if err
      # Try as a file directly (for single-file categories)
      renderGuide "#{guidesPath}/#{category}.md", category, null, res
    else
      renderGuide indexPath, category, null, res

# Two-level path: could be article or subcategory index
app.get '/guides/:category/:item', (req, res) ->
  { category, item } = req.params
  # First check if it's a subcategory with index
  subcategoryIndexPath = "#{guidesPath}/#{category}/#{item}/index.md"
  fs.access subcategoryIndexPath, fs.constants.F_OK, (err) ->
    if not err
      # It's a subcategory, render its index
      renderGuide subcategoryIndexPath, category, item, res
    else
      # It's an article file
      articlePath = "#{guidesPath}/#{category}/#{item}.md"
      renderGuide articlePath, category, null, res

# Three-level path: article within subcategory
app.get '/guides/:category/:subcategory/:article', (req, res) ->
  { category, subcategory, article } = req.params
  articlePath = "#{guidesPath}/#{category}/#{subcategory}/#{article}.md"
  renderGuide articlePath, category, subcategory, res

app.get '/:post', (req, res) ->
  fs.readFile "#{json}/#{req.params.post}.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.render 'pages/Show', {
        post: JSON.parse(file)
      }

app.get '/api/posts', (req, res) ->
  fs.readFile "#{json}/all.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.status(200).json(JSON.parse(file))


app.get '/api/:post', (req, res) ->
  fs.readFile "#{json}/#{req.params.post}.json", 'utf8', (err, file) ->
    if err
      console.error(err)
    else
      res.status(200).json(JSON.parse(file))


###
# Controller Ends here
app.get '*', (req, res) ->
  res.sendFile path.resolve("#{__dirname}/public/404.html"
###

# LISTENER
app.listen PORT, -> present "API Listening on port #{PORT}"
